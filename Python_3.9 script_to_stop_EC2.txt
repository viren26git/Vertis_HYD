Paste in lambda editor:

import json
import boto3

# Initialize a session using Amazon EC2
ec2 = boto3.client('ec2')

def stop_all_running_instances():
    try:
        # Describe instances and filter only running instances
        response = ec2.describe_instances(
            Filters=[{'Name': 'instance-state-name', 'Values': ['running']}]
        )

        # Extract all instance IDs of running instances
        instance_ids = []
        for reservation in response['Reservations']:
            for instance in reservation['Instances']:
                instance_ids.append(instance['InstanceId'])

        # Check if there are any running instances
        if instance_ids:
            print(f"Found the following running instances: {instance_ids}")
            # Stop the running instances
            stop_response = ec2.stop_instances(InstanceIds=instance_ids)
            print(f"Stopping instances: {stop_response}")
        else:
            print("No running instances found.")

    except Exception as e:
        print(f"An error occurred: {e}")

# Run the function to stop all running instances
stop_all_running_instances()
